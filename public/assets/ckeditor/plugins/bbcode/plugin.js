/*
Copyright (c) 2003-2012, CKSource - Frederico Knabben. All rights reserved.
For licensing, see LICENSE.html or http://ckeditor.com/license
*/
!function(){function e(e){var t="";for(var r in e){var n=e[r],i=(r+":"+n).replace(c,";");t+=i}return t}function t(e){var t={};return(e||"").replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(e,r,n){t[r.toLowerCase()]=n}),t}function r(e){return e.replace(/(?:rgb\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\))/gi,function(e,t,r,n){t=parseInt(t,10).toString(16),r=parseInt(r,10).toString(16),n=parseInt(n,10).toString(16);for(var i=[t,r,n],a=0;a<i.length;a++)i[a]=String("0"+i[a]).slice(-2);return"#"+i.join("")})}CKEDITOR.on("dialogDefinition",function(e){var t,r=e.data.name,n=e.data.definition;"link"==r?(n.removeContents("target"),n.removeContents("upload"),n.removeContents("advanced"),t=n.getContents("info"),t.remove("emailSubject"),t.remove("emailBody")):"image"==r&&(n.removeContents("advanced"),t=n.getContents("Link"),t.remove("cmbTarget"),t=n.getContents("info"),t.remove("txtAlt"),t.remove("basic"))});var n={b:"strong",u:"u",i:"em",color:"span",size:"span",quote:"blockquote",code:"code",url:"a",email:"span",img:"span","*":"li",list:"ol"},i={strong:"b",b:"b",u:"u",em:"i",i:"i",code:"code",li:"*"},a={strong:"b",em:"i",u:"u",li:"*",ul:"list",ol:"list",code:"code",a:"link",img:"img",blockquote:"quote"},o={color:"color",size:"font-size"},s={url:"href",email:"mailhref",quote:"cite",list:"listType"},l=CKEDITOR.dtd,u=CKEDITOR.tools.extend({table:1},l.$block,l.$listItem,l.$tableContent,l.$list),c=/\s*(?:;\s*|$)/,f={smiley:":)",sad:":(",wink:";)",laugh:":D",cheeky:":P",blush:":*)",surprise:":-o",indecision:":|",angry:">:(",angel:"o:)",cool:"8-)",devil:">:-)",crying:";(",kiss:":-*"},d={},m=[];for(var h in f)d[f[h]]=h,m.push(f[h].replace(/\(|\)|\:|\/|\*|\-|\|/g,function(e){return"\\"+e}));m=new RegExp(m.join("|"),"g");var p=function(){var e=[],t={nbsp:" ",shy:"­",gt:">",lt:"<"};for(var r in t)e.push(r);return e=new RegExp("&("+e.join("|")+");","g"),function(r){return r.replace(e,function(e,r){return t[r]})}}();CKEDITOR.BBCodeParser=function(){this._={bbcPartsRegex:/(?:\[([^\/\]=]*?)(?:=([^\]]*?))?\])|(?:\[\/([a-z]{1,16})\])/gi}},CKEDITOR.BBCodeParser.prototype={parse:function(t){for(var r,i,a=this,l=0;r=a._.bbcPartsRegex.exec(t);){var u=r.index;if(u>l){var c=t.substring(l,u);a.onText(c,1)}if(l=a._.bbcPartsRegex.lastIndex,i=(r[1]||r[3]||"").toLowerCase(),!i||n[i])if(r[1]){var f=n[i],d={},m={},h=r[2];h&&("list"==i&&(isNaN(h)?/^[a-z]+$/.test(h)?h="lower-alpha":/^[A-Z]+$/.test(h)&&(h="upper-alpha"):h="decimal"),o[i]?("size"==i&&(h+="%"),m[o[i]]=h,d.style=e(m)):s[i]&&(d[s[i]]=h)),("email"==i||"img"==i)&&(d.bbcode=i),a.onTagOpen(f,d,CKEDITOR.dtd.$empty[f])}else r[3]&&a.onTagClose(n[i]);else a.onText(r[0])}t.length>l&&a.onText(t.substring(l,t.length),1)}},CKEDITOR.htmlParser.fragment.fromBBCode=function(e){function t(e){if(l.length>0)for(var t=0;t<l.length;t++){var r=l[t],n=r.name,i=CKEDITOR.dtd[n],a=f.name&&CKEDITOR.dtd[f.name];a&&!a[n]||e&&i&&!i[e]&&CKEDITOR.dtd[e]||(r=r.clone(),r.parent=f,f=r,l.splice(t,1),t--)}}function r(e,t){var r=f.children.length,n=r>0&&f.children[r-1],i=!n&&g.getRule(a[f.name],"breakAfterOpen"),o=n&&n.type==CKEDITOR.NODE_ELEMENT&&g.getRule(a[n.name],"breakAfterClose"),s=e&&g.getRule(a[e],t?"breakBeforeClose":"breakBeforeOpen");c&&(i||o||s)&&c--,c&&e in u&&c++;for(;c&&c--;)f.children.push(n=new CKEDITOR.htmlParser.element("br"))}function n(e,t){r(e.name,1),t=t||f||s;var n=t.children.length,i=n>0&&t.children[n-1]||null;e.previous=i,e.parent=t,t.children.push(e),e.returnPoint&&(f=e.returnPoint,delete e.returnPoint)}var i,o=new CKEDITOR.BBCodeParser,s=new CKEDITOR.htmlParser.fragment,l=[],c=0,f=s;o.onTagOpen=function(e,a){var s=new CKEDITOR.htmlParser.element(e,a);if(CKEDITOR.dtd.$removeEmpty[e])return l.push(s),void 0;var u=f.name,c=u&&(CKEDITOR.dtd[u]||(f._.isBlockLike?CKEDITOR.dtd.div:CKEDITOR.dtd.span));if(c&&!c[e]){var d,m=!1;if(e==u?n(f,f.parent):e in CKEDITOR.dtd.$listItem?(o.onTagOpen("ul",{}),d=f,m=!0):(n(f,f.parent),l.unshift(f),m=!0),f=d?d:f.returnPoint||f.parent,m)return o.onTagOpen.apply(this,arguments),void 0}t(e),r(e),s.parent=f,s.returnPoint=i,i=0,s.isEmpty?n(s):f=s},o.onTagClose=function(e){for(var t=l.length-1;t>=0;t--)if(e==l[t].name)return l.splice(t,1),void 0;for(var r=[],i=[],a=f;a.type&&a.name!=e;)a._.isBlockLike||i.unshift(a),r.push(a),a=a.parent;if(a.type){for(t=0;t<r.length;t++){var o=r[t];n(o,o.parent)}f=a,n(a,a.parent),a==f&&(f=f.parent),l=l.concat(i)}},o.onText=function(e){var i=CKEDITOR.dtd[f.name];(!i||i["#"])&&(r(),t(),e.replace(/([\r\n])|[^\r\n]*/g,function(e,t){if(void 0!==t&&t.length)c++;else if(e.length){var r=0;e.replace(m,function(t,i){n(new CKEDITOR.htmlParser.text(e.substring(r,i)),f),n(new CKEDITOR.htmlParser.element("smiley",{desc:d[t]}),f),r=i+t.length}),r!=e.length&&n(new CKEDITOR.htmlParser.text(e.substring(r,e.length)),f)}}))},o.parse(CKEDITOR.tools.htmlEncode(e));for(;f.type;){var h=f.parent,p=f;n(p,h),f=h}return s},CKEDITOR.htmlParser.BBCodeWriter=CKEDITOR.tools.createClass({$:function(){var e=this;e._={output:[],rules:[]},e.setRules("list",{breakBeforeOpen:1,breakAfterOpen:1,breakBeforeClose:1,breakAfterClose:1}),e.setRules("*",{breakBeforeOpen:1,breakAfterOpen:0,breakBeforeClose:1,breakAfterClose:0}),e.setRules("quote",{breakBeforeOpen:1,breakAfterOpen:0,breakBeforeClose:0,breakAfterClose:1})},proto:{setRules:function(e,t){var r=this._.rules[e];r?CKEDITOR.tools.extend(r,t,!0):this._.rules[e]=t},getRule:function(e,t){return this._.rules[e]&&this._.rules[e][t]},openTag:function(e,t){var r=this;if(e in n){r.getRule(e,"breakBeforeOpen")&&r.lineBreak(1),r.write("[",e);var i=t.option;i&&r.write("=",i),r.write("]"),r.getRule(e,"breakAfterOpen")&&r.lineBreak(1)}else"br"==e&&r._.output.push("\n")},openTagClose:function(){},attribute:function(){},closeTag:function(e){var t=this;e in n&&(t.getRule(e,"breakBeforeClose")&&t.lineBreak(1),"*"!=e&&t.write("[/",e,"]"),t.getRule(e,"breakAfterClose")&&t.lineBreak(1))},text:function(e){this.write(e)},comment:function(){},lineBreak:function(){var e=this;!e._.hasLineBreak&&e._.output.length&&(e.write("\n"),e._.hasLineBreak=1)},write:function(){this._.hasLineBreak=0;var e=Array.prototype.join.call(arguments,"");this._.output.push(e)},reset:function(){this._.output=[],this._.hasLineBreak=0},getHtml:function(e){var t=this._.output.join("");return e&&this.reset(),p(t)}}});var g=new CKEDITOR.htmlParser.BBCodeWriter;CKEDITOR.plugins.add("bbcode",{requires:["htmldataprocessor","entities"],beforeInit:function(e){var t=e.config;CKEDITOR.tools.extend(t,{enterMode:CKEDITOR.ENTER_BR,basicEntities:!1,entities:!1,fillEmptyBlocks:!1},!0)},init:function(e){function n(e){var t=CKEDITOR.htmlParser.fragment.fromBBCode(e),r=new CKEDITOR.htmlParser.basicWriter;return t.writeHtml(r,o),r.getHtml(!0)}var a=e.config,o=new CKEDITOR.htmlParser.filter;o.addRules({elements:{blockquote:function(e){var t=new CKEDITOR.htmlParser.element("div");t.children=e.children,e.children=[t];var r=e.attributes.cite;if(r){var n=new CKEDITOR.htmlParser.element("cite");n.add(new CKEDITOR.htmlParser.text(r.replace(/^"|"$/g,""))),delete e.attributes.cite,e.children.unshift(n)}},span:function(e){var t;(t=e.attributes.bbcode)&&("img"==t?(e.name="img",e.attributes.src=e.children[0].value,e.children=[]):"email"==t&&(e.name="a",e.attributes.href="mailto:"+e.children[0].value),delete e.attributes.bbcode)},ol:function(e){e.attributes.listType?"decimal"!=e.attributes.listType&&(e.attributes.style="list-style-type:"+e.attributes.listType):e.name="ul",delete e.attributes.listType},a:function(e){e.attributes.href||(e.attributes.href=e.children[0].value)},smiley:function(e){e.name="img";var t=e.attributes.desc,r=a.smiley_images[CKEDITOR.tools.indexOf(a.smiley_descriptions,t)],n=CKEDITOR.tools.htmlEncode(a.smiley_path+r);e.attributes={src:n,"data-cke-saved-src":n,title:t,alt:t}}}}),e.dataProcessor.htmlFilter.addRules({elements:{$:function(n){var a,o=n.attributes,s=t(o.style),l=n.name;if(l in i)l=i[l];else if("span"==l){if(a=s.color)l="color",a=r(a);else if(a=s["font-size"]){var u=a.match(/(\d+)%$/);u&&(a=u[1],l="size")}}else if("ol"==l||"ul"==l){if(a=s["list-style-type"])switch(a){case"lower-alpha":a="a";break;case"upper-alpha":a="A"}else"ol"==l&&(a=1);l="list"}else if("blockquote"==l){try{var c=n.children[0],d=n.children[1],m="cite"==c.name&&c.children[0].value;m&&(a='"'+m+'"',n.children=d.children)}catch(h){}l="quote"}else if("a"==l){if(a=o.href)if(-1!==a.indexOf("mailto:"))l="email",n.children=[new CKEDITOR.htmlParser.text(a.replace("mailto:",""))],a="";else{var p=1==n.children.length&&n.children[0];p&&p.type==CKEDITOR.NODE_TEXT&&p.value==a&&(a=""),l="url"}}else if("img"==l){n.isEmpty=0;var g=o["data-cke-saved-src"];if(g&&-1!=g.indexOf(e.config.smiley_path))return new CKEDITOR.htmlParser.text(f[o.alt]);n.children=[new CKEDITOR.htmlParser.text(g)]}return n.name=l,a&&(n.attributes.option=a),null},br:function(e){var t=e.next;return t&&t.name in u?!1:void 0}}},1),e.dataProcessor.writer=g,e.on("beforeSetMode",function(t){t.removeListener();var r=e._.modes.wysiwyg;r.loadData=CKEDITOR.tools.override(r.loadData,function(e){return function(t){return e.call(this,n(t))}})})},afterInit:function(e){var t;e._.elementsPath&&(t=e._.elementsPath.filters)&&t.push(function(t){var r=t.getName(),n=a[r]||!1;if("link"==n&&0===t.getAttribute("href").indexOf("mailto:"))n="email";else if("span"==r)t.getStyle("font-size")?n="size":t.getStyle("color")&&(n="color");else if("img"==n){var i=t.data("cke-saved-src");i&&0===i.indexOf(e.config.smiley_path)&&(n="smiley")}return n})}})}();